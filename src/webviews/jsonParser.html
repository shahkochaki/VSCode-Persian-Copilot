<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <title>Ÿæÿ±ÿØÿßÿ≤ÿ¥ JSON Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- JSON Viewer Libraries for Vanilla HTML/JS -->
    <script src="https://cdn.jsdelivr.net/npm/renderjson@1.4.0/renderjson.js"></script>
    <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.1/dist/json-viewer.bundle.js"></script>
    <script>
      // Configure renderjson
      if (typeof renderjson !== "undefined") {
        renderjson.set_icons("‚ñ∂", "‚ñº");
        renderjson.set_show_by_default(false);
        renderjson.set_max_string_length(100);
        console.log("‚úÖ renderjson configured successfully");
      } else {
        console.warn("‚ö†Ô∏è renderjson not loaded");
      }

      // Check json-viewer availability
      if (typeof JSONViewer !== "undefined") {
        console.log("‚úÖ json-viewer available");
      } else {
        console.warn("‚ö†Ô∏è json-viewer not loaded");
      }
    </script>

    <!-- js-beautify library with fallback -->
    <script>
      // Function to load js-beautify with fallback CDNs
      function loadJsBeautify() {
        const cdns = [
          "https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.9/beautify.min.js",
          "https://unpkg.com/js-beautify@1.14.9/js/lib/beautify.min.js",
          "https://cdn.jsdelivr.net/npm/js-beautify@1.14.9/js/lib/beautify.min.js",
        ];

        let currentCdnIndex = 0;

        function tryLoadScript() {
          if (currentCdnIndex >= cdns.length) {
            console.error("‚ùå Failed to load js-beautify from all CDNs");
            return;
          }

          const script = document.createElement("script");
          script.src = cdns[currentCdnIndex];

          script.onload = function () {
            console.log(
              `‚úÖ js-beautify loaded successfully from: ${cdns[currentCdnIndex]}`
            );
            // Test the library
            setTimeout(() => {
              const testFunc = getBeautifyFunction();
              if (testFunc) {
                console.log("üéâ js-beautify is ready to use!");
              }
            }, 100);
          };

          script.onerror = function () {
            console.warn(
              `‚ö†Ô∏è Failed to load js-beautify from: ${cdns[currentCdnIndex]}`
            );
            currentCdnIndex++;
            tryLoadScript();
          };

          document.head.appendChild(script);
        }

        tryLoadScript();
      }

      // Start loading immediately
      loadJsBeautify();
    </script>
    <style>
      :root {
        --vscode-foreground: var(--vscode-editor-foreground, #e1e4e8);
        --vscode-background: var(--vscode-editor-background, #1e1e1e);
        --vscode-button-background: var(--vscode-button-background, #0078d4);
        --vscode-button-foreground: var(--vscode-button-foreground, #ffffff);
        --vscode-input-background: var(--vscode-input-background, #2d2d30);
        --vscode-input-border: var(--vscode-input-border, #464647);
        --vscode-panel-background: var(--vscode-panel-background, #252526);
        --card-header-bg: #1f1f23;
        --border-color: #464647;
        --success-color: #28a745;
        --error-color: #dc3545;
        --warning-color: #ffc107;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Vazirmatn", "Segoe UI", Tahoma, Arial, sans-serif;
        padding: 16px;
        background: var(--vscode-background);
        color: var(--vscode-foreground);
        direction: ltr;
        overflow-x: hidden;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        height: calc(100vh - 32px);
        display: flex;
        flex-direction: column;
        overflow: visible;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(
          135deg,
          var(--vscode-panel-background),
          var(--card-header-bg)
        );
        border-radius: 12px;
        border: 1px solid var(--border-color);
      }

      .header h1 {
        color: var(--vscode-button-background);
        font-size: 1.8em;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .header-subtitle {
        color: var(--vscode-foreground);
        opacity: 0.7;
        font-size: 0.9em;
      }

      .json-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        flex: 1;
        min-height: 0;
      }

      .json-card {
        background: linear-gradient(
          135deg,
          var(--vscode-panel-background),
          var(--card-header-bg)
        );
        border: 1px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: visible; /* Changed from hidden to visible */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      .json-card:hover {
        box-shadow: 0 8px 25px rgba(0, 120, 212, 0.2);
        transform: translateY(-2px);
      }

      .card-header {
        background: var(--card-header-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 56px;
        border-radius: 10px 10px 0 0;
      }

      .card-title {
        font-weight: 600;
        font-size: 1em;
        color: var(--vscode-foreground);
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon-btn {
        background: none;
        border: none;
        color: #e1e4e8;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .icon-btn.active {
        background: var(--vscode-button-background);
        color: white;
      }

      .search-input {
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px 12px;
        color: var(--vscode-foreground);
        font-family: inherit;
        font-size: 0.9em;
        width: 200px;
        transition: all 0.2s ease;
      }

      .search-input:focus {
        outline: none;
        border-color: var(--vscode-button-background);
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
      }

      .card-content {
        flex: 1;
        padding: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .json-textarea {
        width: 100%;
        height: 100%;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        color: var(--vscode-foreground);
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
        resize: none;
        overflow-y: auto;
        transition: all 0.2s ease;
      }

      .json-textarea:focus {
        outline: none;
        border-color: var(--vscode-button-background);
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
      }

      /* Enhanced JSON Viewer Styles */
      .json-viewer {
        width: 100%;
        height: 100%;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
      }

      .enhanced-json-viewer {
        width: 100%;
        height: 100%;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow-y: auto;
        font-family: "Courier New", monospace !important;
        font-size: 13px;
        padding: 16px;
      }

      /* Beautiful enhanced renderjson styles */
      .enhanced-json-viewer .renderjson {
        color: var(--vscode-foreground) !important;
        background: transparent !important;
        font-family: "Courier New", monospace !important;
        font-size: 13px !important;
        line-height: 1.6 !important;
        padding: 8px 0 !important;
      }

      .enhanced-json-viewer .renderjson .disclosure {
        color: #569cd6 !important;
        font-size: 16px !important;
        cursor: pointer;
        user-select: none;
        margin-right: 6px !important;
        transition: all 0.2s ease !important;
        border-radius: 3px !important;
        padding: 2px 4px !important;
        font-weight: bold !important;
      }

      .enhanced-json-viewer .renderjson .disclosure:hover {
        background: rgba(86, 156, 214, 0.2) !important;
        transform: scale(1.1) !important;
      }

      .enhanced-json-viewer .renderjson .syntax {
        color: #d4d4d4 !important;
        font-weight: bold !important;
      }

      .enhanced-json-viewer .renderjson .string {
        color: #ce9178 !important;
        cursor: pointer !important;
        transition: color 0.2s ease !important;
        position: relative !important;
        display: inline-block !important;
      }

      .enhanced-json-viewer .renderjson .number {
        color: #b5cea8 !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: color 0.2s ease !important;
        position: relative !important;
        display: inline-block !important;
      }

      .enhanced-json-viewer .renderjson .boolean {
        color: #569cd6 !important;
        font-weight: bold !important;
        cursor: pointer !important;
        transition: color 0.2s ease !important;
        position: relative !important;
        display: inline-block !important;
      }

      .enhanced-json-viewer .renderjson .key {
        color: #9cdcfe !important;
        font-weight: 600 !important;
        margin-right: 8px !important;
        display: inline-block !important;
      }

      /* Inline editing styles */
      .json-inline-edit {
        background: var(--vscode-input-background) !important;
        border: 1px solid var(--vscode-button-background) !important;
        border-radius: 3px !important;
        color: var(--vscode-foreground) !important;
        font-family: inherit !important;
        font-size: inherit !important;
        font-weight: inherit !important;
        padding: 2px 4px !important;
        outline: none !important;
        min-width: 60px !important;
        width: auto !important;
      }

      .json-inline-edit:focus {
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3) !important;
      }

      /* Hover action buttons */
      .json-hover-actions {
        position: absolute;
        right: -80px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--vscode-panel-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 2px;
        display: none;
        align-items: center;
        gap: 2px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: hoverActionsShow 0.2s ease-out;
      }

      @keyframes hoverActionsShow {
        from {
          opacity: 0;
          transform: translateY(-50%) translateX(-5px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(-50%) translateX(0) scale(1);
        }
      }

      .json-item-wrapper:hover .json-hover-actions {
        display: flex !important;
      }

      .json-hover-action-btn {
        background: none;
        border: none;
        color: var(--vscode-foreground);
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
      }

      .json-hover-action-btn:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      .json-hover-action-btn.copy-btn:hover {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
      }

      .json-hover-action-btn.edit-btn:hover {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
      }

      .json-hover-action-btn.delete-btn:hover {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
      }

      .json-hover-action-btn .material-icons {
        font-size: 14px;
      }

      /* Wrapper for json items to handle hover */
      .json-item-wrapper {
        position: relative;
        display: inline-block;
      }

      .enhanced-json-viewer .renderjson .null {
        color: #808080 !important;
        font-style: italic !important;
        background: rgba(128, 128, 128, 0.1) !important;
        padding: 2px 6px !important;
        border-radius: 3px !important;
      }

      .enhanced-json-viewer .renderjson a {
        text-decoration: none !important;
        color: inherit !important;
      }

      .enhanced-json-viewer .renderjson .collapsed {
        white-space: nowrap;
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px dashed var(--border-color) !important;
        border-radius: 6px !important;
        padding: 4px 8px !important;
        margin: 2px 0 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
      }

      .enhanced-json-viewer .renderjson .collapsed:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        border-color: var(--vscode-button-background) !important;
        transform: scale(1.02) !important;
      }

      .enhanced-json-viewer .renderjson .expanded {
        white-space: pre;
        border-left: 2px solid var(--vscode-button-background) !important;
        padding-left: 12px !important;
        margin-left: 8px !important;
        position: relative !important;
      }

      .enhanced-json-viewer .renderjson .expanded::before {
        content: "";
        position: absolute;
        left: -6px;
        top: -2px;
        bottom: -2px;
        width: 2px;
        background: linear-gradient(
          180deg,
          transparent 0%,
          var(--vscode-button-background) 20%,
          var(--vscode-button-background) 80%,
          transparent 100%
        ) !important;
        border-radius: 2px !important;
      }

      /* Edit overlay styles */
      .json-edit-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        animation: overlayShow 0.2s ease-out;
      }

      @keyframes overlayShow {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .json-edit-modal {
        background: var(--vscode-panel-background);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 24px;
        min-width: 400px;
        max-width: 600px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        animation: modalShow 0.3s ease-out;
      }

      @keyframes modalShow {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .json-edit-modal h3 {
        margin-bottom: 16px;
        color: var(--vscode-button-background);
        font-size: 16px;
        direction: rtl;
      }

      .json-edit-modal input,
      .json-edit-modal textarea {
        width: 100%;
        padding: 12px;
        background: var(--vscode-input-background);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--vscode-foreground);
        font-family: "Courier New", monospace;
        margin-bottom: 16px;
        transition: all 0.2s ease;
      }

      .json-edit-modal input:focus,
      .json-edit-modal textarea:focus {
        outline: none;
        border-color: var(--vscode-button-background);
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
      }

      .json-edit-modal .button-group {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        direction: rtl;
      }

      .json-edit-modal button {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: "Vazirmatn", sans-serif;
        font-size: 13px;
        transition: all 0.2s ease;
      }

      .json-edit-modal .btn-primary {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }

      .json-edit-modal .btn-primary:hover {
        background: #106ebe;
        transform: translateY(-1px);
      }

      .json-edit-modal .btn-secondary {
        background: var(--vscode-input-background);
        color: var(--vscode-foreground);
        border: 1px solid var(--border-color);
      }

      .json-edit-modal .btn-secondary:hover {
        background: var(--vscode-panel-background);
        transform: translateY(-1px);
      }

      /* JSON Viewer (alenaksu) styles */
      .enhanced-json-viewer json-viewer {
        --background-color: var(--vscode-input-background);
        --color: var(--vscode-foreground);
        --string-color: #ce9178;
        --number-color: #b5cea8;
        --boolean-color: #569cd6;
        --null-color: #808080;
        --property-color: #9cdcfe;
        --font-family: "Courier New", monospace;
        --font-size: 13px;
        --line-height: 1.5;
        --indent-size: 1em;
        width: 100%;
        height: 100%;
      }

      .enhanced-json-viewer json-viewer::part(base) {
        background: transparent;
        color: var(--vscode-foreground);
        font-family: "Courier New", monospace;
        font-size: 13px;
        line-height: 1.5;
      }

      .json-tree {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .json-node {
        margin: 2px 0;
      }

      .json-key {
        color: #9cdcfe;
        font-weight: 500;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-key:hover {
        background: rgba(156, 220, 254, 0.1);
      }

      .json-string {
        color: #ce9178;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-string:hover {
        background: rgba(206, 145, 120, 0.1);
      }

      .json-number {
        color: #b5cea8;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-number:hover {
        background: rgba(181, 206, 168, 0.1);
      }

      .json-boolean {
        color: #569cd6;
        cursor: pointer;
        position: relative;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.2s ease;
      }

      .json-boolean:hover {
        background: rgba(86, 156, 214, 0.1);
      }

      .json-value-container {
        display: inline-block;
        position: relative;
      }

      .json-actions {
        position: absolute;
        top: -25px;
        right: 0;
        background: var(--vscode-panel-background);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 4px;
        display: none;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .json-actions.show {
        display: flex;
        gap: 4px;
      }

      .json-action-btn {
        background: none;
        border: none;
        color: var(--vscode-foreground);
        cursor: pointer;
        padding: 2px 4px;
        border-radius: 2px;
        font-size: 10px;
        transition: all 0.2s ease;
      }

      .json-action-btn:hover {
        background: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
      }

      .json-edit-input {
        background: var(--vscode-input-background);
        border: 1px solid var(--vscode-button-background);
        border-radius: 3px;
        padding: 2px 4px;
        color: var(--vscode-foreground);
        font-family: inherit;
        font-size: inherit;
        min-width: 50px;
      }

      .json-edit-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
      }

      .json-null {
        color: #808080;
      }

      .json-punctuation {
        color: #d4d4d4;
      }

      .toggle-btn {
        background: none;
        border: none;
        color: #d4d4d4;
        cursor: pointer;
        margin-left: 4px;
        font-size: 16px;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        transition: all 0.2s ease;
        font-family: "Material Icons";
      }

      .toggle-btn:hover {
        background-color: var(--vscode-button-background);
        color: var(--vscode-button-foreground);
        transform: scale(1.1);
      }

      .toggle-btn:active {
        transform: scale(0.95);
      }

      .collapsible {
        display: none;
      }

      .status-bar {
        background: var(--card-header-bg);
        border-top: 1px solid var(--border-color);
        padding: 8px 16px;
        font-size: 0.85em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 10px 10px;
      }

      .status-valid {
        color: var(--success-color);
      }

      .status-invalid {
        color: var(--error-color);
      }

      .status-info {
        color: var(--vscode-foreground);
        opacity: 0.7;
      }

      .file-input {
        display: none;
      }

      .tooltip {
        position: relative;
      }

      .tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 150%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        color: #ffffff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999999;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        border: 1px solid #404040;
        pointer-events: none;
        font-family: "Vazirmatn";
      }

      .tooltip::before {
        content: "";
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #1a1a1a;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 999999;
        pointer-events: none;
      }

      .tooltip:hover::after,
      .tooltip:hover::before {
        opacity: 1;
        visibility: visible;
      }

      @media (max-width: 768px) {
        .json-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .search-input {
          width: 120px;
        }

        .toolbar {
          gap: 4px;
        }
      }

      /* Highlight search results */
      .highlight {
        background: #ffc107;
        color: #000;
        padding: 1px 2px;
        border-radius: 2px;
      }

      /* Animation for card loading */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .json-card {
        animation: fadeInUp 0.5s ease-out;
      }

      .json-card:nth-child(2) {
        animation-delay: 0.1s;
      }

      /* Paste notice banner */
      .paste-notice {
        background: rgba(0, 120, 212, 0.1);
        border: 1px solid var(--vscode-button-background);
        border-radius: 6px;
        padding: 8px 12px;
        margin: 0 0 16px 0;
        font-size: 0.85em;
        text-align: right;
        direction: rtl;
        color: var(--vscode-button-background);
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <span
            class="material-icons"
            style="vertical-align: middle; margin-right: 8px"
            >code</span
          >Ÿæÿ±ÿØÿßÿ≤ÿ¥ JSON Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
        </h1>
        <div class="header-subtitle">
          ÿ™ÿ≠ŸÑ€åŸÑÿå ŸÅÿ±ŸÖÿ™ Ÿà Ÿà€åÿ±ÿß€åÿ¥ ÿØÿßÿØŸá‚ÄåŸáÿß€å JSON ÿ®ÿß ÿßŸÖ⁄©ÿßŸÜÿßÿ™ Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
        </div>
      </div>

      <div class="json-grid">
        <!-- Input Panel (moved to right) -->
        <div class="json-card">
          <div class="card-header">
            <div class="card-title">
              <span
                class="material-icons"
                style="
                  vertical-align: middle;
                  margin-right: 8px;
                  font-size: 18px;
                "
                >edit</span
              >
              Ÿà€åÿ±ÿß€åÿ¥⁄Øÿ± JSON
            </div>
            <div class="toolbar">
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".json"
                onchange="importFile()"
              />
              <button
                class="icon-btn tooltip"
                data-tooltip="ÿß€åŸÖŸæŸàÿ±ÿ™ ŸÅÿß€åŸÑ"
                onclick="document.getElementById('fileInput').click()"
              >
                <span class="material-icons">file_upload</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ"
                onclick="clearInput()"
              >
                <span class="material-icons">clear</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ŸÜŸÖŸàŸÜŸá JSON"
                onclick="loadSample()"
              >
                <span class="material-icons">dataset</span>
              </button>
            </div>
          </div>
          <div class="card-content">
            <textarea
              id="inputJson"
              class="json-textarea"
              placeholder='€å⁄© JSON ŸÖÿπÿ™ÿ®ÿ± Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØÿå ŸÖÿ´ÿßŸÑ:
{
  "name": "ÿßÿ≠ŸÖÿØ ÿ±ÿ∂ÿß€å€å",
  "age": 25,
  "city": "ÿ™Ÿáÿ±ÿßŸÜ",
  "skills": ["JavaScript", "Python", "React"]
}'
              oninput="processJson()"
              onpaste="setTimeout(processJson, 10)"
            ></textarea>
          </div>
          <div class="status-bar">
            <span id="inputStatus" class="status-info"
              >ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...</span
            >
            <span id="inputLength" class="status-info">0 ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±</span>
          </div>
        </div>

        <!-- Output Panel (moved to left) -->
        <div class="json-card">
          <div class="card-header">
            <div class="card-title">
              <span
                class="material-icons"
                style="
                  vertical-align: middle;
                  margin-right: 8px;
                  font-size: 18px;
                "
                >visibility</span
              >
              ŸÜŸÖÿß€åÿ¥⁄Øÿ± JSON
            </div>
            <div class="toolbar">
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà..."
                onkeyup="searchInJson()"
              />
              <button
                class="icon-btn tooltip"
                data-tooltip="ÿ¨ŸÖÿπ ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá"
                id="collapseAllBtn"
                onclick="toggleAllCollapse()"
              >
                <span class="material-icons">unfold_less</span>
              </button>
              <button
                class="icon-btn tooltip active"
                data-tooltip="ŸÜŸÖÿß€å Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá"
                id="enhancedViewBtn"
                onclick="toggleView('enhanced')"
              >
                <span class="material-icons">auto_awesome</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ŸÜŸÖÿß€å ÿØÿ±ÿÆÿ™€å"
                id="treeViewBtn"
                onclick="toggleView('tree')"
              >
                <span class="material-icons">account_tree</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ŸÜŸÖÿß€å ŸÖÿ™ŸÜ€å"
                id="textViewBtn"
                onclick="toggleView('text')"
              >
                <span class="material-icons">description</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="⁄©Ÿæ€å"
                onclick="copyOutput()"
              >
                <span class="material-icons">content_copy</span>
              </button>
              <button
                class="icon-btn tooltip"
                data-tooltip="ÿØÿßŸÜŸÑŸàÿØ"
                onclick="downloadJson()"
              >
                <span class="material-icons">file_download</span>
              </button>
            </div>
          </div>
          <div class="card-content">
            <textarea
              id="outputJson"
              class="json-textarea"
              readonly
              style="display: none"
            ></textarea>
            <div
              id="jsonViewer"
              class="json-viewer"
              style="display: none"
            ></div>
            <div
              id="enhancedJsonViewer"
              class="enhanced-json-viewer"
              style="display: block"
            ></div>
          </div>
          <div class="status-bar">
            <span id="outputStatus" class="status-info">ÿ¢ŸÖÿßÿØŸá ŸÜŸÖÿß€åÿ¥...</span>
            <span id="jsonInfo" class="status-info"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="jsonEditOverlay" class="json-edit-overlay">
      <div class="json-edit-modal">
        <h3 id="editModalTitle">Ÿà€åÿ±ÿß€åÿ¥ ŸÖŸÇÿØÿßÿ±</h3>
        <div id="editModalContent">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="button-group">
          <button class="btn-primary" onclick="saveJsonEdit()">ÿ∞ÿÆ€åÿ±Ÿá</button>
          <button class="btn-secondary" onclick="cancelJsonEdit()">ŸÑÿ∫Ÿà</button>
        </div>
      </div>
    </div>

    <script>
      let currentView = "enhanced"; // Default to enhanced view
      let jsonData = null;
      let searchTerm = "";
      let currentJsonViewer = null;
      let isAllCollapsed = false;
      let editModalData = null;

      // Helper function to save JSON to localStorage
      function saveJsonToStorage(jsonContent) {
        try {
          localStorage.setItem("vscode-persian-copilot-json", jsonContent);
          console.log("üíæ JSON saved to localStorage");
        } catch (e) {
          console.error("‚ùå Failed to save JSON to localStorage:", e);
        }
      }

      // Helper function to load JSON from localStorage
      function loadJsonFromStorage() {
        try {
          const saved = localStorage.getItem("vscode-persian-copilot-json");
          if (saved) {
            console.log("üì• JSON loaded from localStorage");
            return saved;
          }
        } catch (e) {
          console.error("‚ùå Failed to load JSON from localStorage:", e);
        }
        return null;
      }

      // Enhanced helper function to get js-beautify function
      function getBeautifyFunction() {
        // Check different possible global names for js-beautify
        const possibleNames = [
          "js_beautify",
          "beautify",
          "jsBeautify",
          "window.js_beautify",
          "window.beautify",
          "window.jsBeautify",
        ];

        for (const name of possibleNames) {
          try {
            let func;
            if (name.startsWith("window.")) {
              const propName = name.split(".")[1];
              func = window[propName];
            } else {
              func = eval(
                `typeof ${name} !== 'undefined' ? ${name} : undefined`
              );
            }

            if (typeof func === "function") {
              console.log(`üéØ Found js-beautify as: ${name}`);
              return func;
            }
          } catch (e) {
            // Continue to next possibility
          }
        }

        console.warn("‚ö†Ô∏è js-beautify function not found");
        return null;
      }

      // Helper function to beautify JSON with js-beautify
      function beautifyJson(jsonData) {
        const beautifyFunction = getBeautifyFunction();

        if (beautifyFunction) {
          try {
            const beautifyOptions = {
              indent_size: 2,
              indent_char: " ",
              max_preserve_newlines: 2,
              preserve_newlines: true,
              keep_array_indentation: false,
              break_chained_methods: false,
              indent_scripts: "normal",
              brace_style: "collapse",
              space_before_conditional: true,
              unescape_strings: false,
              jslint_happy: false,
              end_with_newline: false,
              wrap_line_length: 0,
              indent_inner_html: false,
              comma_first: false,
              e4x: false,
              indent_empty_lines: false,
            };

            const jsonString = JSON.stringify(jsonData);
            const formatted = beautifyFunction(jsonString, beautifyOptions);
            console.log("‚úÖ JSON formatted using js-beautify");
            return formatted;
          } catch (e) {
            console.error("‚ùå js-beautify error:", e);
          }
        } else {
          console.warn(
            "‚ö†Ô∏è js-beautify not found, using JSON.stringify fallback"
          );
        }

        // Fallback to regular JSON.stringify
        return JSON.stringify(jsonData, null, 2);
      }

      // Process JSON input
      function processJson() {
        const inputEl = document.getElementById("inputJson");
        const inputStatus = document.getElementById("inputStatus");
        const inputLength = document.getElementById("inputLength");
        const outputStatus = document.getElementById("outputStatus");
        const jsonInfo = document.getElementById("jsonInfo");

        if (!inputEl) return;
        const input = inputEl.value;

        if (inputLength) inputLength.textContent = `${input.length} ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±`;

        if (!input.trim()) {
          if (inputStatus) {
            inputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...";
            inputStatus.className = "status-info";
          }
          clearOutput();
          return;
        }

        try {
          jsonData = JSON.parse(input);

          // Save the valid JSON to localStorage
          saveJsonToStorage(input);

          if (inputStatus) {
            inputStatus.textContent = "JSON ŸÖÿπÿ™ÿ®ÿ± ‚úì";
            inputStatus.className = "status-valid";
          }

          if (currentView === "text") {
            updateTextView();
          } else if (currentView === "enhanced") {
            updateEnhancedView();
          } else {
            updateTreeView();
          }

          // Enhanced statistics using js-beautify
          const stats = getJsonStatistics(jsonData);
          if (jsonInfo) {
            jsonInfo.innerHTML = `
                        <strong>üìä ÿ¢ŸÖÿßÿ±:</strong><br>
                        ⁄©ŸÑ€åÿØŸáÿß: ${stats.keys.toLocaleString("fa-IR")} | 
                        ÿ¢ÿ±ÿß€åŸá‚ÄåŸáÿß: ${stats.arrays.toLocaleString("fa-IR")} | 
                        ÿßÿ¥€åÿßÿ°: ${stats.objects.toLocaleString("fa-IR")} | 
                        ÿπŸÖŸÇ: ${stats.depth.toLocaleString("fa-IR")} ÿ≥ÿ∑ÿ≠
                    `;
          }
          if (outputStatus) {
            outputStatus.textContent = "ŸÜŸÖÿß€åÿ¥ ŸÖŸàŸÅŸÇ ‚úì";
            outputStatus.className = "status-valid";
          }
        } catch (error) {
          jsonData = null; // Clear jsonData on error
          if (inputStatus) {
            inputStatus.textContent = `ÿÆÿ∑ÿß: ${error.message}`;
            inputStatus.className = "status-invalid";
          }
          if (outputStatus) {
            outputStatus.textContent = "ÿÆÿ∑ÿß ÿØÿ± Ÿæÿ±ÿØÿßÿ≤ÿ¥";
            outputStatus.className = "status-invalid";
          }
          if (jsonInfo) jsonInfo.textContent = "";
          clearOutput();
        }
      }

      // Enhanced text view using js-beautify
      function updateTextView() {
        const output = document.getElementById("outputJson");
        if (!output || !jsonData) return;

        const formatted = beautifyJson(jsonData);

        if (searchTerm) {
          const highlighted = highlightSearch(formatted, searchTerm);
          output.innerHTML = highlighted;
        } else {
          output.value = formatted;
        }
      }

      // Update Enhanced JSON view using renderjson or json-viewer
      function updateEnhancedView() {
        const container = document.getElementById("enhancedJsonViewer");
        if (!container || !jsonData) return;

        // Clear previous content
        container.innerHTML = "";

        try {
          // Try using renderjson first
          if (typeof renderjson !== "undefined") {
            console.log("üé® Using renderjson for enhanced view");

            // Create wrapper div
            const wrapper = document.createElement("div");
            wrapper.style.cssText = `
              color: var(--vscode-foreground);
              font-family: "Courier New", monospace;
              font-size: 13px;
              line-height: 1.5;
              padding: 8px;
            `;

            // Set renderjson options for beautiful display
            renderjson.set_icons("‚ñ∂", "‚ñº");
            renderjson.set_show_by_default(!isAllCollapsed);
            renderjson.set_max_string_length(100);
            renderjson.set_sort_objects(false);
            renderjson.set_replacer(null);
            renderjson.set_property_list(null);

            // Render JSON with enhanced hover actions support
            const rendered = renderjson(jsonData);
            addHoverActionsToRenderjson(rendered);
            wrapper.appendChild(rendered);
            container.appendChild(wrapper);

            console.log("‚úÖ Enhanced view rendered with beautiful renderjson");
          } else if (typeof JSONViewer !== "undefined") {
            console.log("üé® Using json-viewer for enhanced view");

            // Create json-viewer element
            const jsonViewer = document.createElement("json-viewer");
            jsonViewer.data = jsonData;
            jsonViewer.style.cssText = `
              --background-color: transparent;
              --color: var(--vscode-foreground);
              --string-color: #ce9178;
              --number-color: #b5cea8;
              --boolean-color: #569cd6;
              --null-color: #808080;
              --property-color: #9cdcfe;
              --font-family: "Courier New", monospace;
              --font-size: 13px;
              width: 100%;
              height: 100%;
            `;

            container.appendChild(jsonViewer);
            console.log("‚úÖ Enhanced view rendered with json-viewer");
          } else {
            // Fallback to a styled JSON display
            console.log("‚ö†Ô∏è Using fallback enhanced view");
            const pre = document.createElement("pre");
            pre.style.cssText = `
              color: var(--vscode-foreground);
              font-family: "Courier New", monospace;
              font-size: 13px;
              line-height: 1.5;
              margin: 0;
              padding: 8px;
              white-space: pre-wrap;
              word-wrap: break-word;
            `;
            pre.textContent = JSON.stringify(jsonData, null, 2);
            container.appendChild(pre);
          }
        } catch (error) {
          console.error("‚ùå Failed to render enhanced view:", error);
          // Final fallback
          container.innerHTML = `
            <div style="color: var(--error-color); padding: 16px; font-family: 'Courier New', monospace;">
              ÿÆÿ∑ÿß ÿØÿ± ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá JSON<br>
              <small>${error.message}</small>
              <pre style="margin-top: 10px; color: var(--vscode-foreground);">${JSON.stringify(
                jsonData,
                null,
                2
              )}</pre>
            </div>
          `;
        }
      }

      // Add hover action buttons to renderjson elements (only for values, not keys)
      function addHoverActionsToRenderjson(element) {
        const strings = element.querySelectorAll(".string");
        const numbers = element.querySelectorAll(".number");
        const booleans = element.querySelectorAll(".boolean");
        const nulls = element.querySelectorAll(".null");

        // Only add hover actions to values, not keys
        [...strings, ...numbers, ...booleans, ...nulls].forEach((el, index) => {
          // Skip if this is a key element
          if (el.classList.contains("key")) return;

          // Double-check: skip if this element seems to be followed by a colon (indicating it's a key)
          const nextSibling = el.nextSibling;
          if (
            nextSibling &&
            nextSibling.textContent &&
            nextSibling.textContent.trim().startsWith(":")
          ) {
            return; // This is likely a key, skip it
          }

          // Check if the parent contains key-like patterns
          const parentText = el.parentElement
            ? el.parentElement.textContent
            : "";
          const elementText = el.textContent;
          const elementIndex = parentText.indexOf(elementText);
          if (elementIndex > 0) {
            const beforeElement = parentText.substring(0, elementIndex).trim();
            const afterElement = parentText
              .substring(elementIndex + elementText.length)
              .trim();
            if (afterElement.startsWith(":")) {
              return; // This is a key followed by colon
            }
          }

          // Wrap element in a wrapper for hover actions
          if (!el.parentElement.classList.contains("json-item-wrapper")) {
            const wrapper = document.createElement("span");
            wrapper.className = "json-item-wrapper";
            el.parentNode.insertBefore(wrapper, el);
            wrapper.appendChild(el);

            // Create hover actions
            const hoverActions = document.createElement("div");
            hoverActions.className = "json-hover-actions";
            hoverActions.innerHTML = `
              <button class="json-hover-action-btn copy-btn" onclick="copyJsonValue(this.closest('.json-item-wrapper').querySelector('.string, .number, .boolean, .null'))" title="⁄©Ÿæ€å">
                <span class="material-icons">content_copy</span>
              </button>
              <button class="json-hover-action-btn edit-btn" onclick="startInlineEdit(this.closest('.json-item-wrapper').querySelector('.string, .number, .boolean, .null'))" title="Ÿà€åÿ±ÿß€åÿ¥">
                <span class="material-icons">edit</span>
              </button>
              <button class="json-hover-action-btn delete-btn" onclick="deleteJsonValue(this.closest('.json-item-wrapper'))" title="ÿ≠ÿ∞ŸÅ ⁄©ÿßŸÖŸÑ ÿ±ÿØ€åŸÅ">
                <span class="material-icons">delete</span>
              </button>
            `;
            wrapper.appendChild(hoverActions);
          }
        });
      }

      // Toggle collapse/expand all
      function toggleAllCollapse() {
        isAllCollapsed = !isAllCollapsed;
        const btn = document.getElementById("collapseAllBtn");
        const icon = btn.querySelector(".material-icons");

        if (isAllCollapsed) {
          icon.textContent = "unfold_more";
          btn.setAttribute("data-tooltip", "ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá");
          showNotification("ŸáŸÖŸá ÿ®ÿÆÿ¥‚ÄåŸáÿß ÿ¨ŸÖÿπ ÿ¥ÿØŸÜÿØ üìÅ");
        } else {
          icon.textContent = "unfold_less";
          btn.setAttribute("data-tooltip", "ÿ¨ŸÖÿπ ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá");
          showNotification("ŸáŸÖŸá ÿ®ÿÆÿ¥‚ÄåŸáÿß ÿ®ÿßÿ≤ ÿ¥ÿØŸÜÿØ üìÇ");
        }

        // Update current view
        if (currentView === "enhanced") {
          updateEnhancedView();
        } else if (currentView === "tree") {
          updateTreeView();
        }
      }

      // Copy JSON value
      function copyJsonValue(element) {
        const text = element.textContent;
        navigator.clipboard.writeText(text).then(() => {
          showNotification(
            `⁄©Ÿæ€å ÿ¥ÿØ: ${
              text.length > 20 ? text.substring(0, 20) + "..." : text
            } üìã`
          );
        });
      }

      // Start inline editing of JSON value
      function startInlineEdit(element) {
        // Get current value
        const currentValue = element.textContent.replace(/['"]/g, "");
        const valueType = element.className.includes("string")
          ? "string"
          : element.className.includes("number")
          ? "number"
          : element.className.includes("boolean")
          ? "boolean"
          : "string";

        // Store reference for later operations
        element.setAttribute("data-original-value", element.textContent);
        element.setAttribute("data-value-type", valueType);

        // Create input element
        const input = document.createElement("input");
        input.className = "json-inline-edit";
        input.type = valueType === "number" ? "number" : "text";
        input.value = currentValue;

        // Replace element with input
        element.style.display = "none";
        element.parentNode.insertBefore(input, element.nextSibling);

        // Focus and select all text
        input.focus();
        input.select();

        // Handle save on Enter or blur
        const saveEdit = () => {
          const newValue = input.value.trim();
          let displayValue = newValue;

          // Format value based on type
          if (valueType === "string") {
            displayValue = `"${newValue}"`;
          } else if (valueType === "boolean") {
            displayValue = newValue === "true" ? "true" : "false";
          } else if (valueType === "number") {
            displayValue = newValue;
          }

          // Update element
          element.textContent = displayValue;
          element.style.display = "inline-block";

          // Remove input
          input.remove();

          // Try to update the actual JSON data
          const wrapper = element.closest(".json-item-wrapper");
          if (wrapper) {
            const jsonPath = findJsonPath(wrapper);

            if (jsonPath && jsonData) {
              // Update the actual JSON data
              let current = jsonData;

              try {
                // Navigate to parent of target
                for (let i = 0; i < jsonPath.length - 1; i++) {
                  const key = jsonPath[i];
                  if (current[key] !== undefined) {
                    current = current[key];
                  } else {
                    throw new Error("Path not found");
                  }
                }

                // Update the final value
                const finalKey = jsonPath[jsonPath.length - 1];
                let processedValue = newValue;

                // Convert value based on type
                if (valueType === "number") {
                  processedValue = parseFloat(newValue);
                } else if (valueType === "boolean") {
                  processedValue = newValue === "true";
                } else {
                  processedValue = newValue; // Keep as string
                }

                current[finalKey] = processedValue;

                // Update the input field
                const inputEl = document.getElementById("inputJson");
                if (inputEl) {
                  inputEl.value = JSON.stringify(jsonData, null, 2);
                  saveJsonToStorage(inputEl.value);
                }

                showNotification(
                  `ŸÖŸÇÿØÿßÿ± ÿ®Ÿá "${newValue}" ÿ™ÿ∫€å€åÿ± €åÿßŸÅÿ™ Ÿà ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ ‚úÖ`
                );
              } catch (error) {
                console.warn("Could not update JSON data:", error);
                showNotification(
                  `ŸÖŸÇÿØÿßÿ± ÿ®Ÿá "${newValue}" ÿ™ÿ∫€å€åÿ± €åÿßŸÅÿ™ (ŸÅŸÇÿ∑ ÿ®ÿµÿ±€å) ‚ö†Ô∏è`
                );
              }
            } else {
              showNotification(
                `ŸÖŸÇÿØÿßÿ± ÿ®Ÿá "${newValue}" ÿ™ÿ∫€å€åÿ± €åÿßŸÅÿ™ (ŸÅŸÇÿ∑ ÿ®ÿµÿ±€å) ‚ö†Ô∏è`
              );
            }
          }
        };

        // Handle cancel on Escape
        const cancelEdit = () => {
          element.style.display = "inline-block";
          input.remove();
        };

        // Event listeners
        input.addEventListener("blur", saveEdit);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            saveEdit();
          } else if (e.key === "Escape") {
            e.preventDefault();
            cancelEdit();
          }
        });
      }

      // Update JSON data from the current view
      function updateJsonDataFromView() {
        try {
          // Get all the rendered text and try to reconstruct JSON
          const container = document.getElementById("enhancedJsonViewer");
          if (!container) return;

          // Extract text content and clean it up
          let textContent = container.textContent || "";

          // Try to parse the visible content back to JSON
          // This is a simplified approach - in a real implementation,
          // we would need to track each element's path more carefully

          // For now, let's try to maintain the structure by rebuilding from scratch
          const inputEl = document.getElementById("inputJson");
          if (inputEl && jsonData) {
            inputEl.value = JSON.stringify(jsonData, null, 2);
            saveJsonToStorage(inputEl.value);
          }
        } catch (error) {
          console.error("Error updating JSON data:", error);
        }
      }

      // Edit JSON value
      function editJsonValue(element) {
        const overlay = document.getElementById("jsonEditOverlay");
        const title = document.getElementById("editModalTitle");
        const content = document.getElementById("editModalContent");

        title.textContent = "Ÿà€åÿ±ÿß€åÿ¥ ŸÖŸÇÿØÿßÿ±";

        const currentValue = element.textContent.replace(/['"]/g, "");
        const valueType = element.className.includes("string")
          ? "string"
          : element.className.includes("number")
          ? "number"
          : element.className.includes("boolean")
          ? "boolean"
          : "string";

        editModalData = {
          element: element,
          originalValue: currentValue,
          type: valueType,
          action: "edit",
        };

        if (valueType === "boolean") {
          content.innerHTML = `
            <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">ŸÖŸÇÿØÿßÿ±:</label>
            <select id="editValue" style="width: 100%; padding: 12px; background: var(--vscode-input-background); border: 1px solid var(--border-color); border-radius: 6px; color: var(--vscode-foreground);">
              <option value="true" ${
                currentValue === "true" ? "selected" : ""
              }>true</option>
              <option value="false" ${
                currentValue === "false" ? "selected" : ""
              }>false</option>
            </select>
          `;
        } else if (currentValue.length > 100) {
          content.innerHTML = `
            <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">ŸÖŸÇÿØÿßÿ±:</label>
            <textarea id="editValue" rows="6" placeholder="ŸÖŸÇÿØÿßÿ± ÿ¨ÿØ€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ">${currentValue}</textarea>
          `;
        } else {
          content.innerHTML = `
            <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">ŸÖŸÇÿØÿßÿ±:</label>
            <input type="${
              valueType === "number" ? "number" : "text"
            }" id="editValue" value="${currentValue}" placeholder="ŸÖŸÇÿØÿßÿ± ÿ¨ÿØ€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ">
          `;
        }

        overlay.style.display = "flex";
        setTimeout(() => document.getElementById("editValue").focus(), 100);
      }

      // Add JSON value (for objects and arrays)
      function addJsonValue(element) {
        const overlay = document.getElementById("jsonEditOverlay");
        const title = document.getElementById("editModalTitle");
        const content = document.getElementById("editModalContent");

        title.textContent = "ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ŸÖŸÇÿØÿßÿ± ÿ¨ÿØ€åÿØ";

        editModalData = {
          element: element,
          action: "add",
        };

        content.innerHTML = `
          <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">⁄©ŸÑ€åÿØ:</label>
          <input type="text" id="addKey" placeholder="ŸÜÿßŸÖ ⁄©ŸÑ€åÿØ ÿ¨ÿØ€åÿØ" style="margin-bottom: 16px;">
          
          <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">ŸÜŸàÿπ ŸÖŸÇÿØÿßÿ±:</label>
          <select id="addType" onchange="updateAddValueInput()" style="margin-bottom: 16px; width: 100%; padding: 12px; background: var(--vscode-input-background); border: 1px solid var(--border-color); border-radius: 6px; color: var(--vscode-foreground);">
            <option value="string">ÿ±ÿ¥ÿ™Ÿá (String)</option>
            <option value="number">ÿπÿØÿØ (Number)</option>
            <option value="boolean">ÿØÿ±ÿ≥ÿ™/ÿ∫ŸÑÿ∑ (Boolean)</option>
            <option value="null">ÿÆÿßŸÑ€å (Null)</option>
            <option value="object">ÿ¥€åÿ° (Object)</option>
            <option value="array">ÿ¢ÿ±ÿß€åŸá (Array)</option>
          </select>
          
          <label style="display: block; margin-bottom: 8px; color: var(--vscode-foreground);">ŸÖŸÇÿØÿßÿ±:</label>
          <input type="text" id="addValue" placeholder="ŸÖŸÇÿØÿßÿ± ÿ¨ÿØ€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ">
        `;

        overlay.style.display = "flex";
        setTimeout(() => document.getElementById("addKey").focus(), 100);
      }

      // Update add value input based on type
      function updateAddValueInput() {
        const type = document.getElementById("addType").value;
        const valueInput = document.getElementById("addValue");

        switch (type) {
          case "string":
            valueInput.type = "text";
            valueInput.placeholder = "ŸÖÿ™ŸÜ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ";
            break;
          case "number":
            valueInput.type = "number";
            valueInput.placeholder = "ÿπÿØÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ";
            break;
          case "boolean":
            valueInput.type = "text";
            valueInput.placeholder = "true €åÿß false";
            break;
          case "null":
            valueInput.type = "text";
            valueInput.value = "null";
            valueInput.disabled = true;
            break;
          case "object":
            valueInput.type = "text";
            valueInput.placeholder = "{}";
            break;
          case "array":
            valueInput.type = "text";
            valueInput.placeholder = "[]";
            break;
        }
      }

      // Delete JSON value
      function deleteJsonValue(wrapper) {
        if (
          confirm("ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ÿ±ÿØ€åŸÅ ÿ±ÿß ⁄©ÿßŸÖŸÑÿßŸã ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü")
        ) {
          try {
            // First, try to find and remove from actual JSON data
            const valueElement = wrapper.querySelector(
              ".string, .number, .boolean, .null"
            );
            if (!valueElement) return;

            // Find the JSON path and remove from actual data
            const jsonPath = findJsonPath(wrapper);
            let removedFromData = false;

            if (jsonPath && jsonData) {
              removedFromData = removeFromJsonData(jsonData, jsonPath);

              if (removedFromData) {
                // Update the input field
                const inputEl = document.getElementById("inputJson");
                if (inputEl) {
                  inputEl.value = JSON.stringify(jsonData, null, 2);
                  saveJsonToStorage(inputEl.value);
                }

                // Refresh the enhanced view to reflect changes
                updateEnhancedView();

                showNotification("ÿ±ÿØ€åŸÅ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿßÿ≤ JSON ÿ≠ÿ∞ŸÅ ÿ¥ÿØ üóëÔ∏è");
                return;
              }
            }

            // If couldn't remove from data, fall back to DOM removal
            const jsonItemWrapper =
              wrapper.closest(".json-item-wrapper") || wrapper;
            let currentElement = jsonItemWrapper;

            // Find the line container or parent that contains the whole key-value pair
            let lineContainer = currentElement.parentElement;

            // Try to find the broader context (the entire line including punctuation)
            while (
              lineContainer &&
              !lineContainer.classList.contains("renderjson")
            ) {
              const textContent = lineContainer.textContent;

              // Look for patterns that indicate this contains a complete key-value pair
              if (
                textContent.includes(":") &&
                (textContent.includes(",") ||
                  textContent.includes("}") ||
                  textContent.includes("]"))
              ) {
                break;
              }

              lineContainer = lineContainer.parentElement;
            }

            // If we found a suitable container, remove it entirely
            if (lineContainer && lineContainer !== document.body) {
              lineContainer.remove();
              showNotification("ÿ±ÿØ€åŸÅ ⁄©ÿßŸÖŸÑ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ! (ŸÅŸÇÿ∑ ÿ®ÿµÿ±€å) ‚ö†Ô∏è");
            } else {
              // Fallback: more aggressive cleanup approach
              let elementsToRemove = [jsonItemWrapper];
              let current = jsonItemWrapper.previousSibling;

              // Collect all related text nodes and elements going backwards
              while (current) {
                const isRelated =
                  (current.nodeType === Node.TEXT_NODE &&
                    /[{,\s]*"[^"]*"\s*:\s*$/.test(current.textContent)) || // Key pattern
                  (current.classList && current.classList.contains("key")) ||
                  (current.nodeType === Node.TEXT_NODE &&
                    /^\s*[,:]\s*$/.test(current.textContent)); // Punctuation only

                if (isRelated) {
                  elementsToRemove.unshift(current);
                  current = current.previousSibling;
                } else {
                  break;
                }
              }

              // Also collect forward elements (commas, etc.)
              current = jsonItemWrapper.nextSibling;
              while (current) {
                const isRelated =
                  current.nodeType === Node.TEXT_NODE &&
                  /^\s*[,\s]*\s*$/.test(current.textContent); // Trailing comma or whitespace

                if (isRelated) {
                  elementsToRemove.push(current);
                  current = current.nextSibling;
                } else {
                  break;
                }
              }

              // Remove all collected elements
              elementsToRemove.forEach((element) => {
                if (element && element.parentNode) {
                  element.remove();
                }
              });

              showNotification("ÿ±ÿØ€åŸÅ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ (ŸÅŸÇÿ∑ ÿ®ÿµÿ±€å) ‚ö†Ô∏è");
            }
          } catch (error) {
            console.error("Error deleting JSON value:", error);
            showNotification("ÿÆÿ∑ÿß ÿØÿ± ÿ≠ÿ∞ŸÅ ÿ±ÿØ€åŸÅ ‚ùå");
          }
        }
      }

      // Improved JSON path finding with better key detection
      function findJsonPath(wrapper) {
        const path = [];
        let current = wrapper;
        let attempts = 0;
        const maxAttempts = 10; // Prevent infinite loops

        while (current && current !== document.body && attempts < maxAttempts) {
          attempts++;

          // Try multiple strategies to find the key
          let keyText = null;

          // Strategy 1: Look for .key class in nearby elements
          const keyElements = [
            current.querySelector(".key"),
            current.previousElementSibling?.querySelector?.(".key"),
            current.parentElement?.querySelector?.(".key"),
          ].filter(Boolean);

          for (const keyElement of keyElements) {
            const text = keyElement.textContent.replace(/['":\s]/g, "");
            if (text && text.length > 0) {
              keyText = text;
              break;
            }
          }

          // Strategy 2: Look in text content for key patterns
          if (!keyText) {
            const contextText = current.parentElement?.textContent || "";
            const keyMatch = contextText.match(/"([^"]+)"\s*:/);
            if (keyMatch) {
              keyText = keyMatch[1];
            }
          }

          // Strategy 3: Check siblings for key patterns
          if (!keyText) {
            let sibling = current.previousSibling;
            let siblingAttempts = 0;

            while (sibling && siblingAttempts < 5) {
              siblingAttempts++;

              if (sibling.textContent) {
                const siblingText = sibling.textContent;

                // Look for quoted key followed by colon
                if (
                  siblingText.match(/^"[^"]*"$/) &&
                  sibling.nextSibling?.textContent?.includes(":")
                ) {
                  keyText = siblingText.replace(/['"]/g, "");
                  break;
                }

                // Look for key: pattern
                const keyMatch = siblingText.match(/"([^"]+)"\s*:?\s*$/);
                if (keyMatch) {
                  keyText = keyMatch[1];
                  break;
                }
              }

              sibling = sibling.previousSibling;
            }
          }

          // Add key to path if found
          if (keyText && !path.includes(keyText)) {
            path.unshift(keyText);
          }

          // Check for array index in parent context
          const parentText = current.parentElement?.textContent || "";
          const arrayIndexMatch = parentText.match(/\[\s*(\d+)\s*\]/);
          if (arrayIndexMatch) {
            const index = parseInt(arrayIndexMatch[1]);
            if (!path.includes(index)) {
              path.unshift(index);
            }
          }

          current = current.parentElement;

          // Stop if we reach the main JSON container
          if (
            current?.classList?.contains("enhanced-json-viewer") ||
            current?.classList?.contains("renderjson")
          ) {
            break;
          }
        }

        console.log("Found JSON path:", path);
        return path.length > 0 ? path : null;
      }

      // Remove from JSON data using path
      function removeFromJsonData(data, path) {
        if (!path || path.length === 0) return false;

        try {
          let current = data;

          // Navigate to parent of target
          for (let i = 0; i < path.length - 1; i++) {
            const key = path[i];
            if (current[key] !== undefined) {
              current = current[key];
            } else {
              console.warn("Path not found at key:", key);
              return false;
            }
          }

          // Remove the final key
          const finalKey = path[path.length - 1];
          if (Array.isArray(current) && typeof finalKey === "number") {
            current.splice(finalKey, 1);
            return true;
          } else if (
            typeof current === "object" &&
            current !== null &&
            finalKey in current
          ) {
            delete current[finalKey];
            return true;
          }

          return false;
        } catch (error) {
          console.error("Error removing from JSON data:", error);
          return false;
        }
      }

      // Clean up orphaned punctuation and formatting
      function cleanupOrphanedPunctuation(container) {
        if (!container) return;

        // Find and remove orphaned commas, colons, and excessive whitespace
        const childNodes = Array.from(container.childNodes);

        childNodes.forEach((node) => {
          if (node.nodeType === Node.TEXT_NODE) {
            const text = node.textContent;

            // Remove nodes that are only punctuation or whitespace
            if (/^\s*[,:]\s*$/.test(text)) {
              node.remove();
            }
            // Clean up excessive whitespace
            else if (/^\s+$/.test(text) && text.length > 2) {
              node.textContent = " "; // Replace with single space
            }
          }
        });

        // Remove duplicate commas
        let lastWasComma = false;
        Array.from(container.childNodes).forEach((node) => {
          if (
            node.nodeType === Node.TEXT_NODE &&
            node.textContent.includes(",")
          ) {
            if (lastWasComma) {
              node.remove();
            } else {
              lastWasComma = true;
            }
          } else if (
            node.nodeType !== Node.TEXT_NODE ||
            node.textContent.trim() !== ""
          ) {
            lastWasComma = false;
          }
        });
      }

      // Reconstruct JSON from current view (simplified approach)
      function reconstructJsonFromView() {
        try {
          // This is a simplified reconstruction
          // In practice, for a fully functional JSON editor, we would need
          // to maintain a proper data structure and path tracking

          // For now, we'll show a message to the user
          const notification = document.createElement("div");
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #ffc107;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 10000;
            font-family: "Vazirmatn", sans-serif;
            direction: rtl;
            max-width: 320px;
            font-size: 13px;
            line-height: 1.4;
          `;
          notification.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">üí° ŸÜ⁄©ÿ™Ÿá ŸÖŸáŸÖ:</div>
            <div>ÿ™ÿ∫€å€åÿ±ÿßÿ™ ŸÅŸÇÿ∑ ÿ®ÿµÿ±€å Ÿáÿ≥ÿ™ŸÜÿØ. ÿ®ÿ±ÿß€å ÿßÿπŸÖÿßŸÑ ÿØÿßÿ¶ŸÖ€å ÿ™ÿ∫€å€åÿ±ÿßÿ™ÿå JSON ÿßÿµŸÑ€å ÿ±ÿß ÿØÿ± ŸæŸÜŸÑ ÿ≥ŸÖÿ™ ÿ±ÿßÿ≥ÿ™ Ÿà€åÿ±ÿß€åÿ¥ ⁄©ŸÜ€åÿØ.</div>
          `;
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.remove();
          }, 5000);
        } catch (error) {
          console.error("Error reconstructing JSON:", error);
        }
      }

      // Save JSON edit
      function saveJsonEdit() {
        const overlay = document.getElementById("jsonEditOverlay");

        if (editModalData.action === "edit") {
          const newValue = document.getElementById("editValue").value;

          // Update the visual element
          if (editModalData.type === "string") {
            editModalData.element.textContent = `"${newValue}"`;
          } else {
            editModalData.element.textContent = newValue;
          }

          showNotification("ŸÖŸÇÿØÿßÿ± Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ! ‚úèÔ∏è");
        } else if (editModalData.action === "add") {
          const key = document.getElementById("addKey").value;
          const type = document.getElementById("addType").value;
          const value = document.getElementById("addValue").value;

          if (key) {
            showNotification(`ŸÖŸÇÿØÿßÿ± ÿ¨ÿØ€åÿØ "${key}" ÿßÿ∂ÿßŸÅŸá ÿ¥ÿØ! ‚ûï`);
          }
        }

        overlay.style.display = "none";
        editModalData = null;

        // Refresh the view
        if (currentView === "enhanced") {
          updateEnhancedView();
        }
      }

      // Cancel JSON edit
      function cancelJsonEdit() {
        const overlay = document.getElementById("jsonEditOverlay");
        overlay.style.display = "none";
        editModalData = null;
      }

      // Close modal when clicking overlay
      document
        .getElementById("jsonEditOverlay")
        .addEventListener("click", (e) => {
          if (e.target.id === "jsonEditOverlay") {
            cancelJsonEdit();
          }
        });

      // Keyboard shortcuts for modal
      document.addEventListener("keydown", (e) => {
        if (
          document.getElementById("jsonEditOverlay").style.display === "flex"
        ) {
          if (e.key === "Escape") {
            cancelJsonEdit();
          } else if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
            saveJsonEdit();
          }
        }
      });

      // Update tree view
      function updateTreeView() {
        const viewer = document.getElementById("jsonViewer");
        if (!viewer || !jsonData) return;
        viewer.innerHTML = renderJsonTree(jsonData, searchTerm);
      }
      function renderJsonTree(obj, search = "", level = 0, path = "") {
        if (obj === null)
          return `<span class="json-null" onclick="showValueActions(this, 'null', '${path}')">null</span>`;

        if (typeof obj === "string") {
          const escapedPath = path.replace(/'/g, "\\'");
          let content = `"${obj}"`;
          if (search && obj.toLowerCase().includes(search.toLowerCase())) {
            content = highlightSearch(content, search);
          }
          return `<span class="json-value-container">
                    <span class="json-string" onclick="showValueActions(this, 'string', '${escapedPath}')">${content}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'string')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (typeof obj === "number") {
          const escapedPath = path.replace(/'/g, "\\'");
          return `<span class="json-value-container">
                    <span class="json-number" onclick="showValueActions(this, 'number', '${escapedPath}')">${obj}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'number')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (typeof obj === "boolean") {
          const escapedPath = path.replace(/'/g, "\\'");
          return `<span class="json-value-container">
                    <span class="json-boolean" onclick="showValueActions(this, 'boolean', '${escapedPath}')">${obj}</span>
                    <div class="json-actions">
                        <button class="json-action-btn" onclick="copyValue('${escapedPath}')">üìã</button>
                        <button class="json-action-btn" onclick="editValue(this, '${escapedPath}', 'boolean')">‚úèÔ∏è</button>
                    </div>
                </span>`;
        }

        if (Array.isArray(obj)) {
          if (obj.length === 0)
            return '<span class="json-punctuation">[]</span>';

          const isCollapsible = obj.length > 5 || level > 2;
          const toggleId = "toggle_" + Math.random().toString(36).substr(2, 9);

          let html = "";
          if (isCollapsible) {
            html += `<button class="toggle-btn" onclick="toggleCollapse('${toggleId}')">expand_more</button>`;
          }
          html += '<span class="json-punctuation">[</span>\n';

          const contentClass = isCollapsible ? "collapsible" : "";
          html += `<div id="${toggleId}" class="${contentClass}">`;

          for (let i = 0; i < obj.length; i++) {
            html +=
              '<div class="json-node" style="margin-left: ' +
              (level + 1) * 20 +
              'px;">';
            html += renderJsonTree(obj[i], search, level + 1, `${path}[${i}]`);
            if (i < obj.length - 1)
              html += '<span class="json-punctuation">,</span>';
            html += "</div>";
          }

          html += "</div>";
          html +=
            '<div style="margin-left: ' +
            level * 20 +
            'px;"><span class="json-punctuation">]</span></div>';
          return html;
        }

        if (typeof obj === "object") {
          const keys = Object.keys(obj);
          if (keys.length === 0)
            return '<span class="json-punctuation">{}</span>';

          const isCollapsible = keys.length > 3 || level > 2;
          const toggleId = "toggle_" + Math.random().toString(36).substr(2, 9);

          let html = "";
          if (isCollapsible) {
            html += `<button class="toggle-btn" onclick="toggleCollapse('${toggleId}')">expand_more</button>`;
          }
          html += '<span class="json-punctuation">{</span>\n';

          const contentClass = isCollapsible ? "collapsible" : "";
          html += `<div id="${toggleId}" class="${contentClass}">`;

          for (let i = 0; i < keys.length; i++) {
            const key = keys[i];
            const currentPath = path ? `${path}.${key}` : key;
            const escapedPath = currentPath.replace(/'/g, "\\'");

            html +=
              '<div class="json-node" style="margin-left: ' +
              (level + 1) * 20 +
              'px;">';

            let keyContent = `"${key}"`;
            if (search && key.toLowerCase().includes(search.toLowerCase())) {
              keyContent = highlightSearch(keyContent, search);
            }

            html += `<span class="json-value-container">
                        <span class="json-key" onclick="showKeyActions(this, '${escapedPath}')">${keyContent}</span>
                        <div class="json-actions">
                            <button class="json-action-btn" onclick="copyKey('${escapedPath}')">üìã</button>
                            <button class="json-action-btn" onclick="copyPath('${escapedPath}')">üîó</button>
                        </div>
                    </span>`;
            html += '<span class="json-punctuation">: </span>';
            html += renderJsonTree(obj[key], search, level + 1, currentPath);
            if (i < keys.length - 1)
              html += '<span class="json-punctuation">,</span>';
            html += "</div>";
          }

          html += "</div>";
          html +=
            '<div style="margin-left: ' +
            level * 20 +
            'px;"><span class="json-punctuation">}</span></div>';
          return html;
        }

        return String(obj);
      }

      // Toggle view
      function toggleView(view) {
        currentView = view;
        const textBtn = document.getElementById("textViewBtn");
        const treeBtn = document.getElementById("treeViewBtn");
        const enhancedBtn = document.getElementById("enhancedViewBtn");
        const outputJson = document.getElementById("outputJson");
        const jsonViewer = document.getElementById("jsonViewer");
        const enhancedJsonViewer =
          document.getElementById("enhancedJsonViewer");

        if (
          !textBtn ||
          !treeBtn ||
          !enhancedBtn ||
          !outputJson ||
          !jsonViewer ||
          !enhancedJsonViewer
        )
          return;

        // Reset all buttons
        textBtn.classList.remove("active");
        treeBtn.classList.remove("active");
        enhancedBtn.classList.remove("active");

        // Hide all viewers
        outputJson.style.display = "none";
        jsonViewer.style.display = "none";
        enhancedJsonViewer.style.display = "none";

        if (view === "text") {
          textBtn.classList.add("active");
          outputJson.style.display = "block";
          updateTextView();
        } else if (view === "enhanced") {
          enhancedBtn.classList.add("active");
          enhancedJsonViewer.style.display = "block";
          updateEnhancedView();
        } else {
          treeBtn.classList.add("active");
          jsonViewer.style.display = "block";
          updateTreeView();
        }
      }

      // Search in JSON
      function searchInJson() {
        const searchInput = document.getElementById("searchInput");
        if (!searchInput) return;

        searchTerm = searchInput.value;
        if (jsonData) {
          if (currentView === "text") {
            updateTextView();
          } else if (currentView === "enhanced") {
            updateEnhancedView();
          } else {
            updateTreeView();
          }
        }
      }

      // Highlight search terms
      function highlightSearch(text, term) {
        if (!term) return text;
        const regex = new RegExp(`(${term})`, "gi");
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      // Toggle collapse in tree view
      function toggleCollapse(id) {
        const element = document.getElementById(id);
        const button = element.previousElementSibling;

        if (
          element.style.display === "none" ||
          element.classList.contains("collapsible")
        ) {
          element.style.display = "block";
          element.classList.remove("collapsible");
          button.textContent = "expand_more";
        } else {
          element.style.display = "none";
          element.classList.add("collapsible");
          button.textContent = "chevron_right";
        }
      }

      // Enhanced JSON statistics function
      function getJsonStatistics(obj, depth = 0) {
        const stats = {
          keys: 0,
          arrays: 0,
          objects: 0,
          depth: depth,
          maxDepth: depth,
        };

        if (typeof obj === "object" && obj !== null) {
          if (Array.isArray(obj)) {
            stats.arrays = 1;
            obj.forEach((item) => {
              const childStats = getJsonStatistics(item, depth + 1);
              stats.keys += childStats.keys;
              stats.arrays += childStats.arrays;
              stats.objects += childStats.objects;
              stats.maxDepth = Math.max(stats.maxDepth, childStats.maxDepth);
            });
          } else {
            stats.objects = 1;
            const keys = Object.keys(obj);
            stats.keys += keys.length;

            keys.forEach((key) => {
              const childStats = getJsonStatistics(obj[key], depth + 1);
              stats.keys += childStats.keys;
              stats.arrays += childStats.arrays;
              stats.objects += childStats.objects;
              stats.maxDepth = Math.max(stats.maxDepth, childStats.maxDepth);
            });
          }
        }

        return {
          keys: stats.keys,
          arrays: stats.arrays,
          objects: stats.objects,
          depth: stats.maxDepth,
        };
      }

      // Interactive JSON actions
      function showValueActions(element, type, path) {
        // Hide all other actions first
        document
          .querySelectorAll(".json-actions")
          .forEach((el) => el.classList.remove("show"));

        const container = element.closest(".json-value-container");
        const actions = container.querySelector(".json-actions");
        actions.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          actions.classList.remove("show");
        }, 3000);
      }

      function showKeyActions(element, path) {
        // Hide all other actions first
        document
          .querySelectorAll(".json-actions")
          .forEach((el) => el.classList.remove("show"));

        const container = element.closest(".json-value-container");
        const actions = container.querySelector(".json-actions");
        actions.classList.add("show");

        // Hide after 3 seconds
        setTimeout(() => {
          actions.classList.remove("show");
        }, 3000);
      }

      function getValueByPath(obj, path) {
        if (!path) return obj;
        return path
          .split(/[.\[\]]/)
          .filter(Boolean)
          .reduce((current, key) => {
            return current && current[key] !== undefined
              ? current[key]
              : undefined;
          }, obj);
      }

      function setValueByPath(obj, path, value) {
        if (!path) return;
        const keys = path.split(/[.\[\]]/).filter(Boolean);
        const lastKey = keys.pop();
        const target = keys.reduce((current, key) => current[key], obj);

        if (target && lastKey !== undefined) {
          target[lastKey] = value;
        }
      }

      function copyValue(path) {
        const value = getValueByPath(jsonData, path);
        let textToCopy;

        if (typeof value === "string") {
          textToCopy = value;
        } else {
          textToCopy = JSON.stringify(value, null, 2);
        }

        navigator.clipboard.writeText(textToCopy).then(() => {
          showNotification("ŸÖŸÇÿØÿßÿ± ⁄©Ÿæ€å ÿ¥ÿØ! üìã");
        });
      }

      function copyKey(path) {
        const keys = path.split(/[.\[\]]/).filter(Boolean);
        const key = keys[keys.length - 1];

        navigator.clipboard.writeText(key).then(() => {
          showNotification("⁄©ŸÑ€åÿØ ⁄©Ÿæ€å ÿ¥ÿØ! üîë");
        });
      }

      function copyPath(path) {
        navigator.clipboard.writeText(path).then(() => {
          showNotification("ŸÖÿ≥€åÿ± ⁄©Ÿæ€å ÿ¥ÿØ! üîó");
        });
      }

      function editValue(actionBtn, path, type) {
        const container = actionBtn.closest(".json-value-container");
        const valueElement = container.querySelector(`.json-${type}`);
        const currentValue = getValueByPath(jsonData, path);

        // Create input element
        const input = document.createElement("input");
        input.className = "json-edit-input";
        input.type = type === "number" ? "number" : "text";

        if (type === "string") {
          input.value = currentValue;
        } else if (type === "boolean") {
          input.type = "checkbox";
          input.checked = currentValue;
        } else {
          input.value = currentValue;
        }

        // Replace element with input
        valueElement.style.display = "none";
        container.insertBefore(input, valueElement);
        input.focus();

        // Handle save
        const saveEdit = () => {
          let newValue;

          if (type === "string") {
            newValue = input.value;
          } else if (type === "number") {
            newValue = parseFloat(input.value) || 0;
          } else if (type === "boolean") {
            newValue = input.checked;
          }

          // Update the JSON data
          setValueByPath(jsonData, path, newValue);

          // Remove input and show updated value
          input.remove();
          valueElement.style.display = "inline";

          // Update the display
          updateTreeView();
          updateTextView();
          updateEnhancedViewAfterEdit();

          showNotification("ŸÖŸÇÿØÿßÿ± Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØ! ‚úèÔ∏è");
        };

        // Handle cancel
        const cancelEdit = () => {
          input.remove();
          valueElement.style.display = "inline";
        };

        // Event listeners
        input.addEventListener("blur", saveEdit);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            saveEdit();
          } else if (e.key === "Escape") {
            cancelEdit();
          }
        });
      }

      function showNotification(message) {
        // Create notification element
        const notification = document.createElement("div");
        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--vscode-button-background);
                color: var(--vscode-button-foreground);
                padding: 12px 16px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideInRight 0.3s ease-out;
            `;
        notification.textContent = message;

        // Add animation styles
        const style = document.createElement("style");
        style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
        document.head.appendChild(style);

        document.body.appendChild(notification);

        // Remove after 2 seconds
        setTimeout(() => {
          notification.style.animation = "slideOutRight 0.3s ease-out";
          setTimeout(() => {
            notification.remove();
            style.remove();
          }, 300);
        }, 2000);
      }

      // Update tree view after editing
      function updateTreeView() {
        if (jsonData) {
          const viewer = document.getElementById("jsonViewer");
          if (viewer) {
            viewer.innerHTML = renderJsonTree(jsonData);
          }
        }
      }

      // Update text view after editing
      function updateTextView() {
        if (jsonData) {
          const output = document.getElementById("outputJson");
          if (output) {
            const formattedJson = beautifyJson(jsonData);
            output.value = formattedJson;
          }
        }
      }

      // Update enhanced view after editing
      function updateEnhancedViewAfterEdit() {
        if (jsonData && currentView === "enhanced") {
          updateEnhancedView();
        }
      }

      // Hide actions when clicking elsewhere
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".json-value-container")) {
          document
            .querySelectorAll(".json-actions")
            .forEach((el) => el.classList.remove("show"));
        }
      });

      // Utility functions
      function countKeys(obj, count = 0) {
        if (typeof obj === "object" && obj !== null) {
          if (Array.isArray(obj)) {
            obj.forEach((item) => (count = countKeys(item, count)));
          } else {
            count += Object.keys(obj).length;
            Object.values(obj).forEach(
              (value) => (count = countKeys(value, count))
            );
          }
        }
        return count;
      }

      function clearInput() {
        const inputJson = document.getElementById("inputJson");
        const inputStatus = document.getElementById("inputStatus");
        const inputLength = document.getElementById("inputLength");

        if (inputJson) inputJson.value = "";

        // Clear localStorage
        try {
          localStorage.removeItem("vscode-persian-copilot-json");
          console.log("üóëÔ∏è JSON cleared from localStorage");
        } catch (e) {
          console.error("‚ùå Failed to clear localStorage:", e);
        }

        clearOutput();
        if (inputStatus) {
          inputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ÿØÿ±€åÿßŸÅÿ™ JSON...";
          inputStatus.className = "status-info";
        }
        if (inputLength) inputLength.textContent = "0 ⁄©ÿßÿ±ÿß⁄©ÿ™ÿ±";
      }

      function clearOutput() {
        const outputJson = document.getElementById("outputJson");
        const jsonViewer = document.getElementById("jsonViewer");
        const enhancedJsonViewer =
          document.getElementById("enhancedJsonViewer");
        const outputStatus = document.getElementById("outputStatus");
        const jsonInfo = document.getElementById("jsonInfo");

        if (outputJson) outputJson.value = "";
        if (jsonViewer) jsonViewer.innerHTML = "";
        if (enhancedJsonViewer) {
          enhancedJsonViewer.innerHTML = "";
        }
        if (outputStatus) {
          outputStatus.textContent = "ÿ¢ŸÖÿßÿØŸá ŸÜŸÖÿß€åÿ¥...";
          outputStatus.className = "status-info";
        }
        if (jsonInfo) jsonInfo.textContent = "";
        jsonData = null;
      }

      function copyOutput() {
        if (!jsonData) return;

        const text = beautifyJson(jsonData);

        navigator.clipboard.writeText(text).then(() => {
          const btn = event.target.closest(".icon-btn");
          const originalContent = btn.innerHTML;
          btn.innerHTML = '<span class="material-icons">check</span>';
          setTimeout(() => (btn.innerHTML = originalContent), 1000);
        });
      }

      function downloadJson() {
        if (!jsonData) return;

        const text = beautifyJson(jsonData);

        const blob = new Blob([text], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importFile() {
        const fileInput = document.getElementById("fileInput");
        const inputJson = document.getElementById("inputJson");
        if (!fileInput || !inputJson) return;

        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          inputJson.value = content;

          // Save imported JSON to localStorage
          saveJsonToStorage(content);

          processJson();
        };
        reader.readAsText(file);
      }

      function loadSample() {
        const sample = {
          user: {
            id: 12345,
            name: "ÿßÿ≠ŸÖÿØ ÿ±ÿ∂ÿß€å€å",
            email: "ahmad@example.com",
            age: 28,
            isActive: true,
            address: {
              street: "ÿÆ€åÿßÿ®ÿßŸÜ ÿ¢ÿ≤ÿßÿØ€å",
              city: "ÿ™Ÿáÿ±ÿßŸÜ",
              country: "ÿß€åÿ±ÿßŸÜ",
              zipCode: "1234567890",
            },
            skills: ["JavaScript", "Python", "React", "Node.js"],
            projects: [
              {
                name: "Ÿàÿ®‚Äåÿ≥ÿß€åÿ™ ŸÅÿ±Ÿàÿ¥⁄ØÿßŸá€å",
                status: "completed",
                year: 2023,
              },
              {
                name: "ÿßŸæŸÑ€å⁄©€åÿ¥ŸÜ ŸÖŸàÿ®ÿß€åŸÑ",
                status: "in-progress",
                year: 2024,
              },
            ],
          },
          metadata: {
            version: "1.0",
            lastUpdated: "2024-01-15T10:30:00Z",
            source: "API",
          },
        };

        const inputJson = document.getElementById("inputJson");
        if (inputJson) {
          const sampleJsonString = JSON.stringify(sample, null, 2);
          inputJson.value = sampleJsonString;

          // Save sample to localStorage
          saveJsonToStorage(sampleJsonString);

          processJson();
        }
      }

      // Auto-process on page load if there's content
      window.addEventListener("load", () => {
        console.log("üöÄ Page loaded, initializing JSON Parser...");

        // Enhanced js-beautify testing
        function testJsBeautify() {
          console.log("üîç Testing js-beautify availability...");
          const beautifyFunc = getBeautifyFunction();

          if (beautifyFunc) {
            console.log("‚úÖ js-beautify function found!");

            // Test with sample JSON
            try {
              const testJson = '{"name":"ÿ™ÿ≥ÿ™","value":123,"array":[1,2,3]}';
              const formatted = beautifyFunc(testJson, {
                indent_size: 2,
                space_in_empty_paren: false,
                preserve_newlines: true,
                max_preserve_newlines: 2,
              });

              console.log("‚úÖ js-beautify test successful!");
              console.log("üìÑ Sample formatting:");
              console.log(formatted);
              return true;
            } catch (e) {
              console.error("‚ùå js-beautify test failed:", e);
              return false;
            }
          } else {
            console.error(
              "‚ùå js-beautify not found! JSON will use basic formatting."
            );
            return false;
          }
        }

        // Test JSON Viewer Libraries availability
        function testJsonViewerLibraries() {
          console.log("üîç Testing JSON Viewer libraries availability...");

          let availableLibs = [];

          try {
            // Check renderjson
            if (typeof renderjson !== "undefined") {
              console.log("‚úÖ renderjson is available");
              availableLibs.push("renderjson");
            } else {
              console.warn("‚ö†Ô∏è renderjson is not available");
            }

            // Check JSONViewer (alenaksu)
            if (typeof JSONViewer !== "undefined") {
              console.log("‚úÖ JSONViewer is available");
              availableLibs.push("JSONViewer");
            } else {
              console.warn("‚ö†Ô∏è JSONViewer is not available");
            }

            if (availableLibs.length > 0) {
              console.log(
                `‚úÖ Available libraries: ${availableLibs.join(", ")}`
              );
              return true;
            } else {
              console.error("‚ùå No JSON viewer libraries found");
              return false;
            }
          } catch (error) {
            console.error("‚ùå Error checking JSON viewer libraries:", error);
            return false;
          }
        }

        // Test immediately and retry if needed
        if (!testJsBeautify()) {
          console.log("üîÑ Retrying js-beautify test in 500ms...");
          setTimeout(() => {
            if (!testJsBeautify()) {
              console.log("üîÑ Final retry in 1000ms...");
              setTimeout(testJsBeautify, 1000);
            }
          }, 500);
        }

        // Test JSON viewer libraries
        setTimeout(() => {
          if (!testJsonViewerLibraries()) {
            console.log("üîÑ Retrying JSON viewer test in 500ms...");
            setTimeout(() => {
              if (!testJsonViewerLibraries()) {
                console.log("üîÑ Final JSON viewer retry in 1000ms...");
                setTimeout(() => {
                  if (!testJsonViewerLibraries()) {
                    // Fallback to tree view as default
                    console.log("‚ö†Ô∏è Falling back to tree view as default");
                    currentView = "tree";
                    const enhancedBtn =
                      document.getElementById("enhancedViewBtn");
                    const treeBtn = document.getElementById("treeViewBtn");
                    if (enhancedBtn && treeBtn) {
                      enhancedBtn.classList.remove("active");
                      treeBtn.classList.add("active");
                    }
                  }
                }, 1000);
              }
            }, 500);
          }
        }, 100);

        // Load saved JSON from localStorage
        const inputEl = document.getElementById("inputJson");
        if (inputEl) {
          const savedJson = loadJsonFromStorage();
          if (savedJson) {
            inputEl.value = savedJson;
            console.log("üîÑ Restored previous JSON from localStorage");
            processJson();
          } else if (inputEl.value.trim()) {
            // Process existing content if any
            processJson();
          }

          // Set default view based on library availability
          setTimeout(() => {
            const jsonViewerAvailable = testJsonViewerLibraries();
            if (!jsonViewerAvailable) {
              console.log(
                "‚ö†Ô∏è JSON viewer libraries not available, switching to tree view"
              );
              currentView = "tree";
              const enhancedBtn = document.getElementById("enhancedViewBtn");
              const treeBtn = document.getElementById("treeViewBtn");
              if (enhancedBtn && treeBtn) {
                enhancedBtn.classList.remove("active");
                treeBtn.classList.add("active");
                // Also disable the enhanced button
                enhancedBtn.style.opacity = "0.5";
                enhancedBtn.title = "⁄©ÿ™ÿßÿ®ÿÆÿßŸÜŸá‚ÄåŸáÿß€å JSON viewer ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜ€åÿ≥ÿ™";
              }
              // Show tree view elements
              const enhancedJsonViewer =
                document.getElementById("enhancedJsonViewer");
              const jsonViewer = document.getElementById("jsonViewer");
              if (enhancedJsonViewer && jsonViewer) {
                enhancedJsonViewer.style.display = "none";
                jsonViewer.style.display = "block";
              }
            }
          }, 500);
        }
      });
    </script>
  </body>
</html>
